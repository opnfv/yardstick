# Copyright (c) 2017 Intel Corporation.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Include
  include_vars:
    file: "{{rs_file}}"
    name: infra_deploy_vars
    #file: file1
    #name: file1_vars

- name: Store total CPU, RAM, Disk requested resources
  set_fact:
    vcpu_t: "{{item.vcpus|int + vcpu_t|int}}"
    vram_t: "{{item.ram|int + vram_t|int}}"
    disk_t: "{{item.disk|int + disk_t|int}}"
  with_items: "{{infra_deploy_vars.nodes}}"

- name: Fail if not enough RAM
  fail: msg="Failed not enough RAM"
  when: ansible_memory_mb.nocache.free < vram_t|int

- name: Fail if not enough CPU
  fail: msg="Failed not enough CPU"
  when: ansible_processor_vcpus < vcpu_t|int

- name: Get available disk space
  shell: df -BM / | tail -1 | awk '{print substr($4, 1, length($4)-1)}'
  register: disk_avail

- name: Fail if not enough disk space
  fail: msg="Failed not enough disk space"
  when: disk_avail.stdout|int < disk_t|int

  # Also possible to use ansible_all_ipv4_addresses variable from facts
- name: debug print all interface ipv4 data
  set_fact:
    ipv4_addr: "{% set ipv4_addr = ipv4_addr|default([]) + [hostvars[inventory_hostname]['ansible_' + item]['ipv4']['address']] %}{{ ipv4_addr|list }}"
  when: "'ipv4' in hostvars[inventory_hostname]['ansible_'~item]"
  with_items:
     "{{ ansible_interfaces | map('replace', '-','_') | list }}"
