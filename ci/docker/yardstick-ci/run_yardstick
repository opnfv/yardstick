#!/bin/bash
##############################################################################
# Copyright (c) 2015 Ericsson AB and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

set -e

: ${YARDSTICK_REPO:='https://gerrit.opnfv.org/gerrit/yardstick'}
: ${YARDSTICK_REPO_DIR:='/home/yardstick'}
: ${YARDSTICK_BRANCH:='master'}

: ${RELENG_REPO:='https://gerrit.opnfv.org/gerrit/releng'}
: ${RELENG_REPO_DIR:='/home/releng'}
: ${RELENG_BRANCH:='master'}

: ${INSTALLER_TYPE:='fuel'}
: ${INSTALLER_IP:='fuel'}

if [ -z "$INSTALLER_TYPE" ]; then
    echo "INSTALLER_TYPE is unset or empty"
    exit 1
fi

if [ -z "$INSTALLER_IP" ]; then
    echo "INSTALLER_IP is unset or empty"
    exit 1
fi

# releng 
if [ ! -d $RELENG_REPO_DIR ]; then
    git clone RELENG_REPO $RELENG_REPO_DIR
fi
cd $RELENG_REPO_DIR 
git pull && git checkout $RELENG_BRANCH

# yardstick
if [ ! -d $YARDSTICK_REPO_DIR ]; then
    git clone YARDSTICK_REPO $YARDSTICK_REPO_DIR
fi
cd $YARDSTICK_REPO_DIR 
git pull && git checkout $YARDSTICK_BRANCH

git fetch https://gerrit.opnfv.org/gerrit/yardstick refs/changes/01/2201/4 && git checkout FETCH_HEAD

# Create openstack credentials
$RELENG_REPO_DIR/releng/utils/fetch_os_creds.sh \
    -d /tmp/openrc \
    -i ${INSTALLER_TYPE} -a ${INSTALLER_IP} 

source /tmp/openrc

$YARDSTICK_REPO_DIR/ci/yardstick-verify

