##############################################################################
# Copyright (c) 2019 Huawei Technologies Co.,Ltd and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

FROM alpine:3.8

LABEL image=opnfv/yardstick

ARG BRANCH=master

# GIT repo directory
ENV REPOS_DIR="/home/opnfv/repos" \
    IMAGE_DIR="/home/opnfv/images/"

# Yardstick repo
ENV YARDSTICK_REPO_DIR="${REPOS_DIR}/yardstick/" \
    RELENG_REPO_DIR="${REPOS_DIR}/releng" \
    STORPERF_REPO_DIR="${REPOS_DIR}/storperf"

RUN apk add --no-cache \
        python libffi py-pip bash \
        grep sed wget ca-certificates git openssh-client \
        expect curl sshpass nginx uwsgi supervisor vim sudo tar && \
    apk add --no-cache --virtual .build-deps \
        python-dev build-base linux-headers libffi-dev \
        openssl-dev

RUN pip install --no-cache-dir --upgrade pip==19.0.2 && \
    pip install appdirs==1.4.0 pyopenssl==17.5.0 \
        openstacksdk==0.11.3 python-openstackclient==3.14.2 python-heatclient==1.14.0 ansible==2.5.5 && \
    rm -rf /root/.cache/pip

RUN mkdir -p ${REPOS_DIR}

RUN git config --global http.sslVerify false
#For developers: To test your changes you must comment out the git clone for ${YARDSTICK_REPO_DIR}.
#You must also uncomment the RUN and COPY commands below.
#You must run docker build from your yardstick directory on the host.
RUN git clone --depth 1 -b $BRANCH https://gerrit.opnfv.org/gerrit/yardstick ${YARDSTICK_REPO_DIR}
#RUN mkdir ${YARDSTICK_REPO_DIR}
#COPY ./ ${YARDSTICK_REPO_DIR}
RUN git clone --depth 1 https://gerrit.opnfv.org/gerrit/releng ${RELENG_REPO_DIR}
RUN git clone --depth 1 -b $BRANCH https://gerrit.opnfv.org/gerrit/storperf ${STORPERF_REPO_DIR}

RUN ansible-playbook -i ${YARDSTICK_REPO_DIR}/ansible/install-inventory.ini -c local -vvv -e INSTALLATION_MODE="container" ${YARDSTICK_REPO_DIR}/ansible/install.yaml

RUN ${YARDSTICK_REPO_DIR}/docker/supervisor.sh

RUN echo "daemon off;" >> /etc/nginx/nginx.conf
# nginx=5000, rabbitmq=5672
EXPOSE 5000 5672

ADD http://download.cirros-cloud.net/0.3.5/cirros-0.3.5-x86_64-disk.img ${IMAGE_DIR}
ADD http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img ${IMAGE_DIR}

# For developers: when `docker build ...` is running from YARDSTICK_REPO_DIR, please change
#                 path `./exec_tests.sh` -> `./docker/exec_tests.sh``.
COPY ./exec_tests.sh /usr/local/bin/

ENV NSB_DIR="/opt/nsb_bin"
ENV PYTHONPATH="${PYTHONPATH}:${NSB_DIR}/trex_client:${NSB_DIR}/trex_client/stl"

WORKDIR ${REPOS_DIR}
CMD ["/usr/bin/supervisord"]
